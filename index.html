<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8" />
        <title>Shockwave.io</title>

        <style>
        #myCanvas {
          position: absolute;
          left: 100px;
          border:1px solid #505050;
        }
        #textBlock {
          position: absolute;
          left:900px
        }
        </style>
    </head>


    <body>

        <h1>Shockwave.io connection test 2: group chat</h1>


        <canvas id="myCanvas" width="750" height="450">
          Your browser does not support the HTML5 canvas tag.
        </canvas>


        <script src="/socket.io/socket.io.js"></script>

        <script>

        //https://stackoverflow.com/questions/5203407/how-to-detect-if-multiple-keys-are-pressed-at-once-using-javascript
        var keyMap = {}; // You could also use an array
        onkeydown = onkeyup = function(e){
            e = e || event; // to deal with IE
            keyMap[e.keyCode] = e.type == 'keydown';
            /* insert conditional here */
        }

        var characterDatas = new Map();
        var myID = -1;
        var myCharacter;

        function CharacterData(id, name, x, y, score, velocity) {
          this.id = id;
          this.x = x;
          this.y = y;
          this.name = name;
          this.score = score;
          this.vx = 0;
          this.vy = 0;
          this.velocity = velocity;
        }

        CharacterData.prototype.movement = function() {

            this.slowDownVertical();
            this.slowDownHorizontal();
            if (keyMap[87]) {
              this.moveUp();
            }
            if (keyMap[83]) {
              this.moveDown();
            }
            if (keyMap[65]) {
              this.moveLeft();
            }
            if (keyMap[68]) {
              this.moveRight();
            }
            this.x += this.vx;
            this.y += this.vy;

            this.sendPositionToServer();
        }

        CharacterData.prototype.sendPositionToServer = function  () {
          socket.emit('update position', this.id, this.x, this.y);
        }

        CharacterData.prototype.slowDownHorizontal = function() {
          if (Math.abs(this.vx) > 0.01){
              this.vx *= 0.9;
          } else {
              this.vx = 0;
          }
        }

        CharacterData.prototype.slowDownVertical = function() {
          if (Math.abs(this.vy) > 0.01){
              this.vy *= 0.9;
          } else {
              this.vy = 0;
          }
        }

        CharacterData.prototype.moveUp = function() {
          this.vy += (-this.velocity - this.vy) / 10;

        }

        CharacterData.prototype.moveDown = function() {
          this.vy += (this.velocity - this.vy) / 10;
        }

        CharacterData.prototype.moveLeft = function() {
          this.vx += (-this.velocity - this.vx) / 10;
        }

        CharacterData.prototype.moveRight = function() {
          this.vx += (this.velocity - this.vx) / 10;
        }








        /**
        * Socket.io connection handler portion BEGINS
        */

        var updated = false;

        var socket = io.connect('localhost:40378');
        socket.on('message', function(message) {
            document.getElementById("messages").innerHTML += message +"<br/>";
        });


        socket.on('init synchronization',function(id) {
          myID = id;
        });

        socket.on('set user myCharacter', function(bool) {
            myCharacter = characterDatas.get(myID);
        });

        socket.on('update character', function(id, name, x, y, vel, score) {
          var currentCharacter = characterDatas.get(id);
          if (currentCharacter != null)
          {
            currentCharacter.id = id;
            currentCharacter.name = name;
            currentCharacter.x = x;
            currentCharacter.y = y;
            currentCharacter.score = score;
            currentCharacter.velocity = vel;
          } else {
              characterDatas.set(id, new CharacterData(id, name, x, y, vel, score));
          }
        });

        /*socket.on("update user movement", function(index,) {

        });*/


        socket.on("confirm updated", function(str) {
          updated = true;
        });

        socket.on("delete user", function(id) {
          characterDatas.delete(id);
        });

        var givenName = false;
        function sendStuff() {

            var x = document.forms["chat"].elements[0].value;
            if (givenName) {
        	      socket.emit("message", x);
            } else {
                socket.emit("name", x);
                document.getElementById("button").innerHTML = "Send message";
                givenName = true;
            }


        }


        /**Socket.io connection handler portion ENDS*/


        var c = document.getElementById("myCanvas");
        //should be updated == TRUE, temporarily this
        function drawCanvas () {
              var ctx = c.getContext("2d");
              ctx.beginPath();
              ctx.rect(0, 0, 750, 450);
              ctx.fillStyle = "white";
              ctx.fill();

              ctx.font = "30px Arial";
              //ctx.fillText("Hello I'm a test canvas", 10, 50);
              for (let [k, v] of characterDatas){
                var currentCharacter = v;
                ctx.beginPath();
                ctx.arc(currentCharacter.x, currentCharacter.y, 30, 0, 2 * Math.PI);
                ctx.stroke();
                ctx.font = "30px Arial";

                ctx.strokeText(currentCharacter.name, currentCharacter.x, currentCharacter.y);
              }
        }

        function incrementScore(){
            characterDatas.get(myID).score += 3;
            socket.emit("update score", myID, myCharacter.score);
        }

        document.getElementById("myCanvas").addEventListener("click", incrementScore, false);



        document.addEventListener('keydown', function(event){
        });

        function gameSingleFrame() {
            drawCanvas();
            myCharacter.movement();

        }

        setInterval(gameSingleFrame, 33);

        function getStats() {
          alert("Character data length: " + characterDatas.size + "\n");
          for (let [k, v] of characterDatas){
            alert("character with id" + k + ": "+ v.x + ", " + v.y + "," + v.score);
          }
        }
        </script>



        <div id="textBlock">
        <form id='chat'>
        <input type="text" name="inputText" value="" autocomplete="off"><br>
        </form>
        <button id="button" onClick=sendStuff()>Please input your name</button>
        <div id="messages"></div>
        <button id="stats" onClick=getStats()>Get stats</button>
      </div>



    </body>
</html>
